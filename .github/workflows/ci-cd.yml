name: CI-CD-Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build, Scan, Push, Deploy (SSH -> EC2)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout (so commit info is available in run logs)
      uses: actions/checkout@v4

    - name: Run CI/CD on EC2 via SSH
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        # private key must be stored in secrets as multiline PEM
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_SSH_PORT || '22' }}
        script: |
          set -euo pipefail

          # working directory on EC2 where repo will be cloned/updated
          WORKDIR=~/workspace/puzzle-game-java
          REPO_URL=https://github.com/${{ github.repository }}
          BRANCH=${GITHUB_REF#refs/heads/} || main

          echo ">>> Prepare workspace"
          mkdir -p "$(dirname "$WORKDIR")"
          if [ -d "$WORKDIR/.git" ]; then
            echo "Repo exists. Fetching latest..."
            cd "$WORKDIR"
            git fetch --all
            git checkout ${GITHUB_REF#refs/heads/} || git checkout -B main origin/main
            git reset --hard origin/${GITHUB_REF#refs/heads/}
          else
            echo "Cloning repo..."
            git clone --single-branch --branch ${GITHUB_REF#refs/heads/} "$REPO_URL" "$WORKDIR"
            cd "$WORKDIR"
          fi

          echo ">>> Ensure ~/.m2 exists"
          mkdir -p ~/.m2

          echo ">>> Create temporary Maven settings.xml with Nexus credentials"
          cat > ~/.m2/settings.xml <<-EOM
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                        https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>nexus</id>
                <username>${{ secrets.NEXUS_USERNAME }}</username>
                <password>${{ secrets.NEXUS_PASSWORD }}</password>
              </server>
            </servers>
          </settings>
          EOM
          chmod 600 ~/.m2/settings.xml

          echo ">>> Run Maven build (compile, test, package)"
          mvn -B -s ~/.m2/settings.xml clean verify

          # SonarQube analysis (if token provided)
          if [ -n "${{ secrets.SONAR_TOKEN }}" ]; then
            echo ">>> Running SonarQube analysis"
            mvn -B -s ~/.m2/settings.xml sonar:sonar \
              -Dsonar.host.url="${{ secrets.SONAR_HOST }}" \
              -Dsonar.login="${{ secrets.SONAR_TOKEN }}"
          else
            echo ">>> SONAR_TOKEN not provided; skipping SonarQube analysis"
          fi

          echo ">>> Deploy artifact to Nexus (maven deploy)"
          mvn -B -s ~/.m2/settings.xml deploy

          echo ">>> Build Docker image for Tomcat (assumes Dockerfile present at repo root or adjust path)"
          DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/pz-tomcat:${GITHUB_SHA::7}
          docker build -t "$DOCKER_IMAGE" -f Dockerfile .

          echo ">>> Login to DockerHub and push"
          echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          docker push "$DOCKER_IMAGE"

          # Replace container deployment commands below with how you deploy tomcat on your host.
          # Example: stop existing container (if any) and run new image:
          if docker ps --filter "name=pz-tomcat" --format '{{.Names}}' | grep -q 'pz-tomcat'; then
